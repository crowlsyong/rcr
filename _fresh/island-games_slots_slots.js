import{a as v}from"./chunk-K4SWCROJ.js";import"./chunk-6ZHUC2IY.js";import"./chunk-ZEW3OCQC.js";import{a as L}from"./chunk-MEABNXAK.js";import{a as u,b as k,c as I,d as K}from"./chunk-NGSZJRVL.js";import"./chunk-V66ALGLP.js";var c=5,Y=88,p=88,q=14,N=2,$=[50,100,250,1e3,1e4],z=3,V=p*z,Q=Math.floor((V-p)/2),j=Q+p;function H(i,o,m){return Math.max(o,Math.min(m,i))}function C(i){let o=Number(i.split("-")[1]);return Number.isFinite(o)?H(o-1,0,c-1):0}function M(i){return Number.isFinite(i)?H(Math.floor(i)-1,0,c-1):0}async function A(i){let o=await i.text().catch(()=>"");try{let m=o?JSON.parse(o):null;return{ok:!0,text:o,json:m}}catch{return{ok:!1,text:o,json:null}}}function X(){let[i,o]=u("idle"),[m,S]=u(""),[P,g]=u(null),[F,O]=u(null),[y,B]=u($[0]),[f,D]=u(""),b=I(!1),h=I([0,0,0]),x=K(()=>Array.from({length:c}).map((e,s)=>`/styles/slots/icon-${s+1}.png`),[]);function R(e,s,t){let n=-((s*c+t)*p)+j;e.style.transition="none",e.style.transform=`translate3d(0, ${n}px, 0)`}function T(e,s,t,n){return new Promise(r=>{let a=document.getElementById(`slot-strip-${e}`);if(!a){r();return}let l=h.current[e],d=N,E=N+n;R(a,d,l);let w=-((E*c+s)*p)+j;a.style.willChange="transform",requestAnimationFrame(()=>{a.style.transition=`transform ${t}ms cubic-bezier(.22,.61,.36,1)`,a.style.transform=`translate3d(0, ${w}px, 0)`}),globalThis.setTimeout(()=>{h.current[e]=s,a.style.willChange="auto",r()},t+30)})}async function U(e,s){try{let t=await fetch("/api/v0/slots/slots-api",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({apiKey:e,action:"claim",claimId:s})}),n=await A(t),r=n.json;return!t.ok||!r?.ok?(console.error("claim failed",{status:t.status,text:n.text,j:r}),{ok:!1}):{ok:!0,payoutSent:!!r.payoutSent}}catch(t){return console.error(t),{ok:!1}}}async function _(){if(!b.current)try{b.current=!0,g(null),O(null),o("spinning"),S("calling api");let e=await fetch("/api/v0/slots/slots-api",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({bet:y,apiKey:f,action:"spin"})}),s=await A(e),t=s.json;if(!e.ok||!t?.ok||!t?.outcome){console.error("slots api bad response",{status:e.status,text:s.text,j:t}),g(t?.detail||t?.error||`api error ${e.status}`),o("idle"),b.current=!1;return}let n=t.outcome;console.log("[slots] response",{bet:y,claimId:typeof t.claimId=="string"?t.claimId:null,payoutSent:!!t.payoutSent,outcome:n});let r=!!t.payoutSent,a=typeof t.claimId=="string"?t.claimId:null;n.win&&!r&&a&&f&&(S("payout retry"),r=!!(await U(f,a)).payoutSent,r||g("payout failed"));let l=n.icons?[M(n.icons[0]),M(n.icons[1]),M(n.icons[2])]:[C(n.combo?.[0]??"icon-1"),C(n.combo?.[1]??"icon-1"),C(n.combo?.[2]??"icon-1")];S("spinning");let d=2200,E=420,w=T(0,l[0],d,4),J=T(1,l[1],d+E,5),W=T(2,l[2],d+2*E,6);await Promise.all([w,J,W]),console.log("[slots] final",{bet:y,finalIdx:l,outcomePayout:n.payout,reason:n.reason,win:n.win,payoutSent:r}),O({win:n.win,payout:n.payout,combo:l,reason:n.reason,payoutSent:r});let G=n.win?r?"paid":"unpaid":"loss";S(n.win?`${n.reason} (${G})`:"loss"),o("done")}catch(e){console.error(e),g("spin error"),o("idle")}finally{b.current=!1}}return k(()=>{(()=>{try{h.current=[Math.floor(Math.random()*c),Math.floor(Math.random()*c),Math.floor(Math.random()*c)];for(let t=0;t<3;t++){let n=document.getElementById(`slot-strip-${t}`);n&&R(n,N,h.current[t])}}catch(t){console.error(t)}})();let s=t=>{t.repeat||(t.code==="Space"||t.code==="Enter")&&_()};return globalThis.addEventListener("keydown",s),()=>globalThis.removeEventListener("keydown",s)},[y,f]),L(v,{icons:x,iconUrls:x,iconWidth:Y,iconHeight:p,repeatCount:q,apiKey:f,setApiKey:D,bet:y,setBet:B,bets:$,canSpin:!b.current,spinState:i,status:m,error:P,result:F,onSpin:_})}export{X as default};
