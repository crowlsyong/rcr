import{a as D,c as E}from"./chunk-YW3YQVQS.js";import{b as g}from"./chunk-CRCKSX74.js";import{a as t}from"./chunk-MEABNXAK.js";import{b as A}from"./chunk-NGSZJRVL.js";import{d as B}from"./chunk-V66ALGLP.js";function $(b){return new DOMParser().parseFromString(b,"text/html").body.textContent||""}var K={IMF:{id:"PdLcZARORc",name:"IMF",description:"Awards loan as bounty on the IMF market."},BANK:{id:"tqQIAgd6EZ",name:"BANK",description:"Awards loan as bounty on the BANK market."},RISK:{id:"QEytQ5ch0P",name:"RISK",description:"Awards loan as bounty on the RISK Payment Portal."},OFFSHORE:{id:"CAQchupgyN",name:"OFFSHORE",description:"Awards loan as bounty on the OFFSHORE market."}};function O(b){let r="";if(!Array.isArray(b))return r;for(let a of b)a.type==="text"&&typeof a.text=="string"?r+=a.text:Array.isArray(a.content)&&(r+=O(a.content)),a.type==="mention"&&a.attrs&&typeof a.attrs.label=="string"&&(r+=`@${a.attrs.label}`);return r}function Q(b){let{apiKey:r,loanAmount:a,username:c,lenderUsername:M,insuranceFee:h,loanDueDate:P,selectedCoverage:T,isProcessingPayment:S,paymentMessage:I,paymentMessageType:F,cooldownActive:p,cooldownMessage:C,institution:u,useInstitution:d}=b,w=g([]),i=g(null),f=g(null),y=g(!1),o=g(null),v=g(null),s=g(!1),m=g(null);A(()=>{let e;return s.value&&(e=setTimeout(()=>s.value=!1,4e3)),()=>clearTimeout(e)},[s.value]),A(()=>{async function e(){if(m.value=null,c.value)try{let{userData:l,fetchSuccess:n}=await D(c.value);n&&l?m.value=l.id:m.value=null}catch(l){console.error("Error fetching borrower ID for comment filtering:",l),m.value=null}}e()},[c.value]),A(()=>{async function e(){if(d.value&&u.value&&r.value){if(c.value&&m.value===null)return;y.value=!0,f.value=null,i.value=null,o.value=null,v.value=null,s.value=!1;let l=u.value?K[u.value]?.id:null;if(!l){f.value="Invalid institution selected.",y.value=!1,w.value=[];return}try{let n=await E(l,m.value||void 0);n.success&&n.data?w.value=n.data.filter(x=>x.content&&typeof x.content=="object"&&Array.isArray(x.content.content)&&O(x.content.content).trim()!=="").sort((x,j)=>j.createdTime-x.createdTime):f.value=`Failed to fetch comments: ${n.error||"Unknown error"}`}catch(n){f.value=`Network error fetching comments: ${typeof n=="object"&&n!==null&&"message"in n?n.message:String(n)}`}finally{y.value=!1}}else w.value=[],i.value=null,f.value=null,o.value=null,v.value=null,s.value=!1}e()},[d.value,u.value,r.value,m.value]),A(()=>{d.value||(u.value=null,i.value=null,o.value=null,v.value=null,I.value="",F.value="",p.value=!1,C.value="",s.value=!1)},[d.value]);let N=e=>{u.value=e,i.value=null,o.value=null,v.value=null,s.value=!1},U=async()=>{S.value=!0,o.value=null,v.value=null,I.value="",F.value="",C.value="";try{let e={apiKey:r.value,borrowerUsername:c.value,lenderUsername:M.value,loanAmount:a.value,coverage:T.value,dueDate:P.value,institution:u.value,commentId:i.value},l=await fetch("/api/v0/insurance/execute",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=await l.json();if(!l.ok||!n.success)throw new Error(n.error||"An unknown error occurred.");o.value=`\u2705 Successfully awarded M${a.value} bounty and paid insurance fee!`,v.value="success",I.value=`\u2705 Loan (via bounty) and insurance fee processed via ${u.value} institution.`,F.value="success",p.value=!0}catch(e){let l=typeof e=="object"&&e!==null&&"message"in e?e.message:String(e);o.value=`\u26D4 Error processing: ${l}`,v.value="error",I.value=`\u26D4 Payment failed: ${l}`,F.value="error",p.value=!0}finally{S.value=!1,s.value=!1}},H=()=>{if(o.value=null,v.value=null,I.value="",F.value="",C.value="",p.value){o.value=`\u26D4 ${C.value}`,v.value="error";return}if(!i.value||!r.value||a.value<=0||!c.value||!M.value||!u.value||h===null||h<0||!P.value||T.value===null){o.value="\u26D4 Please fill in all required fields and select a comment before awarding.",v.value="error";return}s.value?U():s.value=!0},R=S.value||p.value||!i.value||!r.value||a.value<=0||!c.value||!M.value||!u.value||h===null||h<0||!P.value||T.value===null,k=`Award M${a.value} Bounty & Pay RISK Fee (M${Math.round(h||0)})`;return S.value?k="Processing...":s.value?k="Are you sure? Click to Confirm Bounty":p.value&&(k="Please wait..."),t("div",{class:"mt-4 p-4 bg-gray-800 border border-gray-700 rounded-md shadow-sm",children:[t("h3",{class:"text-lg font-bold text-gray-200 mb-4",children:"Institutional Funding"}),t("div",{class:"flex items-center justify-between mb-4",children:[t("label",{htmlFor:"use-institution-toggle",class:"text-gray-300 mr-2",children:"Fund with an Institution?"}),t("button",{id:"use-institution-toggle",type:"button",onClick:()=>d.value=!d.value,class:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 ${d.value?"bg-blue-600":"bg-gray-700"}`,children:t("span",{class:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${d.value?"translate-x-6":"translate-x-1"}`})})]}),d.value&&t(B,{children:[t("p",{class:"text-sm text-gray-400 mb-3",children:"If selected, your loan mana will be awarded as a bounty on the chosen institution's market. Your insurance fee will also be paid to the RISK Payment Portal."}),t("div",{class:"flex flex-wrap gap-2 mb-4",children:Object.entries(K).map(([e,{name:l}])=>t("button",{type:"button",onClick:()=>N(e),class:`flex-1 p-2 rounded-md font-semibold text-sm transition-colors duration-200 min-w-[100px] ${u.value===e?"bg-blue-600 text-white":"bg-gray-700 hover:bg-gray-600 border border-gray-700"}`,children:l},e))}),u.value&&t("p",{class:"text-sm text-gray-400 mb-3",children:K[u.value]?.description}),u.value&&t(B,{children:[t("label",{htmlFor:"comment-select",class:"block text-sm font-medium text-gray-300 mb-2",children:"Select a comment to award bounty:"}),!r.value&&!y.value&&t("p",{class:"text-orange-400 text-sm mb-2",children:"Please enter your Manifold API key to fetch comments."}),y.value&&t("p",{class:"text-gray-400 text-sm",children:"Loading comments..."}),f.value&&t("p",{class:"text-red-400 text-sm",children:f.value}),!y.value&&w.value.length===0&&!f.value&&r.value&&t("p",{class:"text-gray-400 text-sm",children:["No comments found for this institution's market.",c.value&&m.value===null?" (Could not verify borrower username for filtering, ensure API key is valid.)":c.value&&m.value?" (Filtered by borrower.)":""]}),!y.value&&w.value.length>0&&t("div",{class:"max-h-60 overflow-y-auto border border-gray-700 rounded-md p-2 bg-gray-900",children:w.value.map(e=>t("div",{onClick:()=>i.value=e.id,class:`p-2 my-1 cursor-pointer rounded-md transition-colors duration-150 ${i.value===e.id?"bg-blue-700 border border-blue-500":"bg-gray-700 hover:bg-gray-600 border border-gray-700"}`,children:[t("p",{class:"text-gray-200 text-sm",children:$(O(e.content.content))||`[Comment without visible text - ID: ${e.id}]`}),t("p",{class:"text-xs text-gray-400 mt-1",children:["Comment ID: ",e.id," ","| User: @",e.userUsername||e.userId]})]},e.id))}),i.value&&t("p",{class:"mt-2 text-sm text-green-400",children:["Selected Comment ID: ",i.value]}),t("button",{type:"button",onClick:H,disabled:R,class:`mt-4 w-full p-3 rounded-md text-lg font-semibold transition-colors duration-200 ${R?"bg-gray-700 text-gray-400 cursor-not-allowed":s.value?"bg-yellow-700 hover:bg-yellow-800 text-white":"bg-purple-600 hover:bg-purple-700 text-white"}`,children:k}),o.value&&!S.value&&t("p",{class:"mt-2 text-center text-sm text-gray-200",children:o.value})]})]})]})}export{Q as a};
