import{a as Y}from"./chunk-VKMAZ3AH.js";import{a as G}from"./chunk-HH3PC2H5.js";import{a as q}from"./chunk-YW3YQVQS.js";import{a as X}from"./chunk-Q6UR6VXR.js";import{a as _}from"./chunk-CVKZWSML.js";import{b as E}from"./chunk-CRCKSX74.js";import{a as c}from"./chunk-MEABNXAK.js";import{a as A,b as u,c as J}from"./chunk-NGSZJRVL.js";import{d as O}from"./chunk-V66ALGLP.js";var Ie={25:.02,50:.05,75:.08,100:.12};function Fe(z){let{username:s,lenderUsername:d,loanAmount:r,selectedCoverage:t,loanDueDate:o,managramMessage:C,lenderFeePercentage:i,apiKey:B,handleApiKeyInput:Q,partnerCodeInput:L,partnerCodeValid:v,partnerCodeMessage:f,isCodeChecking:W,setIsCodeChecking:$,discountSource:T,insuranceFee:y,setInsuranceFee:m,initialInsuranceFeeBeforeDiscount:Z,setInitialInsuranceFeeBeforeDiscount:D,riskBaseFee:h,setriskBaseFee:U,getPolicyEndDate:ee,isLenderUsernameValid:I,isBorrowerUsernameValid:F,sameUserError:k,loanDueDateError:g,setDurationFee:H}=z,[P,ae]=A(""),[K,ne]=A(""),p=E(null),S=E(""),b=E(""),re=J(null),M=E(0),te=a=>parseFloat(Math.min(1379e-8*Math.pow(a,1.5),.5).toFixed(4)),le=(a,n)=>{let e=Math.abs(n.getTime()-a.getTime());return Math.ceil(e/(1e3*60*60*24))};u(()=>{let a=setTimeout(()=>ae(s.value),500);return()=>clearTimeout(a)},[s.value]),u(()=>{let a=setTimeout(()=>ne(d.value),500);return()=>clearTimeout(a)},[d.value]),u(()=>{s.value&&d.value&&s.value.toLowerCase()===d.value.toLowerCase()?k.value="Borrower and Lender cannot be the same user.":k.value=""},[s.value,d.value]);async function ue(a){if(!a){oe();return}try{let e=await(await fetch(`/api/v0/credit-score?username=${a}`)).json();if(e.error)throw new Error(e.error);if(!e.userExists||e.userDeleted){p.value=null,S.value=e.userDeleted?`User @${a} is deleted`:`User @${a} not found`,F.value=!1,U(0),m(null),D(null);return}p.value={username:e.username,creditScore:e.creditScore,riskBaseFee:e.riskBaseFee,avatarUrl:e.avatarUrl,userId:e.userId},U(e.riskBaseFee),S.value="",F.value=!0}catch(n){S.value=`Network/fetch error: ${typeof n=="object"&&n!==null&&"message"in n?n.message:String(n)}`,p.value=null,F.value=!1,U(0),m(null),D(null)}}async function se(a){if(!a){b.value="",I.value=!1;return}try{let{userData:n,fetchSuccess:e,userDeleted:l}=await q(a);e&&n&&!l?(b.value="",I.value=!0):(b.value="Lender username not found or deleted.",I.value=!1)}catch(n){b.value=`Error checking lender username: ${typeof n=="object"&&n!==null&&"message"in n?n.message:String(n)}`,I.value=!1}}function oe(){p.value=null,S.value="",U(0),m(null),D(null),F.value=!1}u(()=>{ue(P)},[P]),u(()=>{se(K)},[K]),u(()=>{let a=L.value.trim();if(a===""){v.value=!1,f.value="",T.value=null;return}$(!0),f.value="Checking code...";let n=setTimeout(async()=>{try{let e=await fetch("/api/v0/validate-partner-code",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:a})});if(!e.ok)throw new Error(`Server error: ${e.statusText}`);let l=await e.json();v.value=l.isValid,f.value=l.message,T.value=l.discountType||null}catch(e){v.value=!1,f.value=`Error checking code: ${typeof e=="object"&&e!==null&&"message"in e?e.message:String(e)}`,T.value=null}finally{$(!1)}},500);return()=>clearTimeout(n)},[L.value]);let ie=()=>{if(r.value<=0||t.value===null||h===0||!o.value||g.value){m(null),D(null),M.value=0,H(0);return}let a=Ie[t.value],n=new Date;n.setHours(0,0,0,0);let e=new Date(o.value+"T00:00:00"),l=le(n,e),N=te(l);M.value=N;let x=Math.ceil(r.value*N);H(x);let V=h*r.value+r.value*a+x;D(V),v.value&&(V*=.75),m(V)};u(()=>{ie()},[r.value,t.value,h,v.value,o.value,g.value]),u(()=>{let a=i.value!==null&&r.value>0?Math.round(r.value*(i.value/100)):0,n=r.value+a,e=`Loan M${r.value}. M${n} due back ${o.value}.`;t.value!==null&&t.value>0&&(e+=` | ${t.value}% INSURED BY RISK`),e.length>100?C.value=e.substring(0,100):C.value=e},[r.value,i.value,o.value,t.value]);let ce=a=>{t.value===a?t.value=null:t.value=a},de=a=>{s.value=a.target.value,m(null)},ve=a=>{d.value=a.target.value},me=a=>{let e=a.target.value.replace(/[^0-9]/g,"");r.value=e?parseInt(e):0},ge=a=>{let n=a.target.value;o.value=n;let e=new Date;e.setHours(0,0,0,0);let l=new Date(n+"T00:00:00");isNaN(l.getTime())?g.value="Please select a valid date.":l<=e?g.value="Loan due date must be at least tomorrow.":g.value=""},pe=a=>{L.value=a.target.value},fe=a=>{C.value=a.target.value},R=a=>{let e=a.target.value.replace(/[^0-9]/g,"");i.value=e?parseInt(e):null},w=r.value||0,j=i.value!==null&&w>0?Math.round(w*(i.value/100)):0,De=y!==null?Math.round(y):0,he=r.value>0&&y!==null&&M.value>0?Math.ceil(w*M.value):0;return c(O,{children:[c("div",{class:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-6",children:[c(X,{username:s,debouncedUsername:P,inputRef:re,handleUsernameInput:de,error:S,scoreData:p,riskBaseFee:h,lenderUsername:d,handleLenderUsernameInput:ve,lenderUsernameError:b,loanAmount:r,handleLoanInput:me,isBorrowerUsernameValid:F,isLenderUsernameValid:I,sameUserError:k}),c(Y,{loanDueDate:o,handleLoanDueDateInput:ge,loanDueDateError:g,getPolicyEndDate:ee,selectedCoverage:t,handleCoverageClick:ce,apiKey:B,handleApiKeyInput:Q})]}),B.value.length>=8&&c(_,{managramMessage:C,handleManagramMessageInput:fe,partnerCodeInput:L,handlePartnerCodeInput:pe,isCodeChecking:W,partnerCodeMessage:f,partnerCodeValid:v,lenderFeePercentage:i,handleLenderFeePercentageInput:R,loanAmount:r}),c(G,{insuranceFee:y,currentLoanAmount:w,username:s,currentLenderFee:j,lenderFeePercentage:i,handleLenderFeePercentageInput:R,initialInsuranceFeeBeforeDiscount:Z,partnerCodeValid:v,netLenderGain:j-De,apiKeyLength:B.value.length,durationFee:he,selectedCoverage:t,riskBaseFee:h,loanDueDate:o,borrowerCreditScore:p.value?.creditScore||0})]})}export{Fe as a};
