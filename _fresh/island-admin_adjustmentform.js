import{a as F}from"./chunk-2ZV2IV35.js";import{a as E}from"./chunk-4WXBQVKC.js";import"./chunk-CRCKSX74.js";import"./chunk-GI7LLYGM.js";import{a as U}from"./chunk-P44UUGPW.js";import"./chunk-I6W4WTVW.js";import"./chunk-HNGXSQHJ.js";import{a as j}from"./chunk-ZGK2NUGW.js";import"./chunk-DT2WSX4O.js";import"./chunk-DGI52A4N.js";import"./chunk-URWAKGWD.js";import{a as r}from"./chunk-MEABNXAK.js";import{a as t,b as S,e as o}from"./chunk-NGSZJRVL.js";import"./chunk-V66ALGLP.js";function N(){return typeof globalThis.location>"u"?"":new URLSearchParams(globalThis.location.search).get("q")||""}function q(){let f=N(),[l,O]=t(f),[s,x]=t(null),[v,a]=t(null),[u,b]=t(!1),[T,i]=t(null),[A,d]=t(""),[D,h]=t(0);S(()=>{if(typeof window<"u"){let e=new URL(globalThis.location.href);l?e.searchParams.set("q",l):e.searchParams.delete("q"),globalThis.history.replaceState(null,"",e.toString())}},[l]);let M=o(e=>{console.log("[AdjustmentForm] Debounced username received from UsernameInput:",e),O(e),a(null),i(null),d("")},[]),P=o(e=>{console.log("[AdjustmentForm] User overview fetched:",e),x(e),i(null),d("")},[]),I=async e=>{b(!0),i(null),d(""),console.log("[AdjustmentForm] Submitting form with payload:",e);try{let c=await fetch(v?"/api/v0/admin/update-override":"/api/v0/admin/adjust-score",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),w=await c.text(),m;try{m=JSON.parse(w)}catch{throw new Error(`API Error: Unexpected response format. Received non-JSON: "${w.substring(0,100)}..."`)}if(!c.ok||!m.success)throw new Error(m.error||"Failed to apply adjustment.");i(m.message||(v?"Adjustment updated successfully!":"Adjustment added successfully!")),d("success"),console.log("[AdjustmentForm] Form submitted successfully."),a(null),h(g=>g+1),await new Promise(g=>setTimeout(g,500))}catch(n){let c=`Error: ${typeof n=="object"&&n!==null&&"message"in n?n.message:String(n)}`;i(c),d("error"),console.error("[AdjustmentForm] Form submission error:",n)}finally{b(!1)}},R=o(()=>{console.log("[AdjustmentForm] Form fields reported success.")},[]),p=o(()=>{console.log("[AdjustmentForm] User display requested refresh."),h(e=>e+1)},[]),C=o(e=>{console.error("[AdjustmentForm] Form fields reported error:",e),i(e),d("error")},[]),y=o(e=>{console.log("[AdjustmentForm] Received modify event from table:",e),a(e)},[]);return r("div",{class:"bg-gray-900 p-6 rounded-lg shadow-xl border border-gray-700",children:[r("div",{class:"mb-6",children:r(F,{initialValue:f,onDebouncedChange:M,isFetching:u})}),r("div",{class:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[r("div",{children:r(U,{debouncedUsername:l,onUserOverviewFetched:P,isLoadingParent:u,refreshTrigger:D,onDeleteSuccess:p,onModify:y})}),s&&!s.userDeleted?r(E,{userOverview:s,modifyingEvent:v,setModifyingEvent:a,isSubmitting:u,submitMessage:T,submitMessageType:A,onSubmit:I,onSuccess:R,onError:C}):r("div",{class:"flex items-center justify-center bg-gray-800 p-6 rounded-lg border border-gray-700 h-full",children:r("p",{class:"text-gray-400 text-center",children:"Search for a user on the left to add or modify adjustments."})})]}),s&&!s.userDeleted&&s.existingOverrideEvents.length>0?r("div",{class:"mt-8 pt-8 border-t border-gray-700",children:r(j,{overrideEvents:s.existingOverrideEvents,userId:s.userId,username:s.username,isLoadingParent:u,onDeleteSuccess:p,onModify:y})}):s&&!s.userDeleted&&s.existingOverrideEvents.length===0?r("div",{class:"mt-8 pt-8 border-t border-gray-700",children:r("div",{class:"p-4 bg-gray-800 rounded-lg shadow-inner border border-gray-700",children:[r("h4",{class:"text-md font-semibold text-white mb-4",children:["Existing Overrides for @",s.username,":"]}),r("p",{class:"text-gray-400 text-sm",children:"No existing overrides for this user."})]})}):null,s?.userDeleted&&r("div",{class:"mt-6 w-full flex items-center justify-center bg-yellow-900/20 p-6 rounded-lg border border-yellow-700",children:r("p",{class:"text-yellow-400 text-center",children:["User ",s.username," ","is deleted and cannot be adjusted."]})})]})}export{q as default};
