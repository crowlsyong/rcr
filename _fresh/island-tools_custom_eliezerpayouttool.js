import{b as t}from"./chunk-CRCKSX74.js";import"./chunk-GI7LLYGM.js";import{i as A,j as D}from"./chunk-URWAKGWD.js";import{a as e}from"./chunk-MEABNXAK.js";import{a as O,b,d as B,e as z}from"./chunk-NGSZJRVL.js";import{d as N}from"./chunk-V66ALGLP.js";var Y=D,_=A;function V(){let w=t("https://manifold.markets/EliezerYudkowsky/what-book-will-i-enjoy-reading"),P=t(""),r=t(20),u=t([]),E=t(null),m=t(null),M=t(null),S=t(null),L=t(!1),y=t(null),x=t(!1),d=t(!1),v=t(!1),i=t(null),g=t(null),f=t(null),h=t(null),k=t(null),c=t(null),I=t(null),T=t(!1),R=t(""),o=t(!0),C=t(w.value),U=t(r.value),j=t(o.value),[J,K]=O(!1);b(()=>{K(!0)},[]),b(()=>{let a=setTimeout(()=>{C.value=w.value},500);return()=>clearTimeout(a)},[w.value]),b(()=>{let a=setTimeout(()=>{U.value=r.value},500);return()=>clearTimeout(a)},[r.value]),b(()=>{let a=setTimeout(()=>{j.value=o.value},500);return()=>clearTimeout(a)},[o.value]);let F=z(async()=>{if(!C.value||U.value===null){x.value=!1,u.value=[],E.value=null,m.value=null,M.value=null,S.value=null,y.value=null;return}L.value=!0,y.value=null,x.value=!1,u.value=[],E.value=null,m.value=null,M.value=null,S.value=null,d.value=!1,i.value=null,g.value=null,f.value=null,I.value=null,h.value=null,k.value=null,c.value=null;try{let l=await(await fetch("/api/v0/eliezer/calculate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({marketUrl:C.value,apologyPercentage:U.value,useStartingBetLogic:j.value})})).json();l.success?(u.value=l.users||[],E.value=l.marketQuestion||null,m.value=l.marketSlug||null,M.value=l.totalUsersToPay||0,S.value=l.totalPayoutMana||0,x.value=!0):y.value=l.error||"Unknown calculation error."}catch(a){y.value=`Network error: ${typeof a=="object"&&a!==null&&"message"in a?a.message:String(a)}`}finally{L.value=!1}},[C.value,U.value,j.value]);b(()=>{F()},[F]),b(()=>{let a;return d.value&&(a=setTimeout(()=>{d.value=!1},5e3)),()=>{a&&clearTimeout(a)}},[d.value]);let q=a=>{let l=a.target.value,n=parseInt(l,10);!isNaN(n)&&n>=0?r.value=n:l===""&&(r.value=0)},H=async()=>{if(d.value=!1,v.value=!0,i.value=null,g.value=null,f.value=null,I.value=null,h.value=null,k.value=null,c.value=null,!P.value){i.value="API Key is required to execute payouts.",v.value=!1;return}if(!m.value){i.value="Market information is missing. Please calculate first.",v.value=!1;return}let a=m.value,l=a.split("/").pop();if(!l){i.value="Could not derive actual Manifold market ID from slug for execution.",v.value=!1;return}try{let s=await(await fetch("/api/v0/eliezer/execute",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:P.value,users:u.value,marketId:l,marketSlugFull:a,apologyPercentage:r.value,customManagramMessage:T.value?R.value:null,useStartingBetLogic:o.value})})).json();s.success?(i.value=s.message||"Payouts completed!",f.value=s.transactions||[],g.value=s.errors||[],h.value=s.totalErrors||0,k.value=s.marketResolution?.message||"Market resolution status unknown.",c.value=s.detailedLogs||[]):(i.value=s.message||"Payouts failed.",g.value=s.errors||[],h.value=s.totalErrors||0,k.value=s.marketResolution?.message||"Market resolution status unknown.",c.value=s.detailedLogs||[]),I.value=s.totalPaidMana||0,c.value&&c.value.length>0&&$()}catch(n){i.value=`Network error during execution: ${typeof n=="object"&&n!==null&&"message"in n?n.message:String(n)}`}finally{v.value=!1}},X=()=>{d.value?H():d.value=!0},$=()=>{if(c.value){let a=`eliezer_payout_logs_${Date.now()}.json`,l=JSON.stringify(c.value,null,2),n=new Blob([l],{type:"application/json"}),s=URL.createObjectURL(n),p=document.createElement("a");p.href=s,p.download=a,document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(s)}},Q=B(()=>{if(!x.value||u.value.length===0||!m.value)return"Managram preview will appear here after calculation results are available.";let a=u.value[0],l=Math.round(a.originalInvested),n=a.calculatedPayout,s=`https://manifold.markets/${m.value}`,p=o.value?"starting bet":"total invested";return`${r.value}% Payment as an apology for locked funds in ${s} | Based on ${p} M${l} | Apology payment M${n}`},[x.value,u.value,r.value,m.value,o.value]);return e("div",{class:"w-full max-w-2xl mx-auto p-4 bg-gray-800 rounded-lg shadow-xl text-gray-100",children:[e("div",{class:"flex items-center justify-between mb-4",children:[e("h2",{class:"text-2xl font-bold text-blue-400",children:"Payout Tool"}),e("div",{class:"flex items-center gap-2",children:[e("span",{class:"text-sm text-gray-400",children:["Viewing payout based on","  ",e("span",{class:"font-semibold text-white",children:o.value?"Starting Bet":"Total Invested"})]}),e("button",{type:"button",onClick:()=>o.value=!o.value,title:o.value?"Payout based on starting bet":"Payout based on total invested",class:"flex items-center justify-center p-1 rounded-full focus:outline-none ring-0 focus:ring-0",children:J&&(o.value?e(Y,{class:"w-10 h-10 text-blue-500",size:40}):e(_,{class:"w-10 h-10 text-gray-500",size:40}))})]})]}),e("p",{class:"text-sm text-gray-400 mb-4",children:["This tool helps calculate and execute compensation for users who invested in a Manifold market. It will send back a % of their investment.",e("br",{})]}),e("div",{class:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e("div",{children:[e("label",{htmlFor:"apiKey",class:"block text-sm font-medium text-gray-300 mb-1",children:"Your Manifold API Key (required for execution)"}),e("input",{type:"password",id:"apiKey",value:P.value,onInput:a=>P.value=a.target.value,placeholder:"xxxxxx-xxxxx-xxxxxxxxxxxxxxxxxxxx",class:"w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-border-500"}),e("p",{class:"mt-1 text-xs text-gray-400",children:"Find your API key on your Manifold profile page by clicking the gear icon and selecting Account Settings."}),e("p",{class:"mt-1 text-xs text-gray-400",children:"This key is NOT stored on our servers."})]}),e("div",{children:[e("label",{htmlFor:"apologyPercentage",class:"block text-sm font-medium text-gray-300 mb-1",children:"Apology Payout Percentage"}),e("div",{class:"relative flex items-center",children:[e("input",{type:"number",id:"apologyPercentage",value:r.value,onInput:q,placeholder:"20",min:"0",class:"w-full p-2 pr-8 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500"}),e("span",{class:"absolute right-3 text-gray-400 text-lg",children:"%"})]})]})]}),e("div",{class:"mb-4",children:[e("label",{htmlFor:"marketUrl",class:"block text-sm font-medium text-gray-300 mb-1",children:"Manifold Market URL"}),e("input",{type:"text",id:"marketUrl",value:w.value,onInput:a=>w.value=a.target.value,placeholder:"e.g., https://manifold.markets/EliezerYudkowsky/what-book-will-i-enjoy-reading",class:"w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500"})]}),L.value&&e("p",{class:"text-blue-300 text-center mt-4 mb-4",children:"Calculating payouts..."}),y.value&&e("p",{class:"text-red-400 text-center mt-4",children:["Error: ",y.value]}),x.value&&!L.value&&e("div",{class:"mt-6 p-4 bg-gray-700 rounded-md shadow-inner",children:[e("h3",{class:"text-xl font-semibold mb-3 text-blue-300",children:"Calculation Results"}),e("p",{class:"text-gray-200",children:["Market: ",e("span",{class:"font-medium",children:E.value})," "]}),e("p",{class:"text-gray-200",children:["Total Unique Investors:"," ",e("span",{class:"font-medium",children:M.value})]}),e("p",{class:"text-gray-200",children:["Total Mana to Payout (",r.value,"% apology):"," ",e("span",{class:"font-medium",children:["M",S.value]})]}),e("h4",{class:"text-lg font-semibold mt-4 mb-2 text-blue-300",children:"Users to Compensate:"}),e("div",{class:"max-h-60 overflow-y-auto border border-gray-600 rounded-md p-2 bg-gray-800",children:u.value.length===0?e("p",{class:"text-gray-400",children:"No users found with invested mana."}):e("ul",{class:"space-y-1",children:u.value.map(a=>e("li",{class:"flex items-center text-xs",children:[e("span",{class:"text-gray-300 mr-2",children:["@",a.username]}),e("span",{class:"text-gray-400",children:["(Invested: M",a.originalInvested.toFixed(2),")"]}),e("span",{class:"ml-auto font-bold text-green-300",children:["Payout: M",a.calculatedPayout]})]},a.userId))})}),e("div",{class:"mt-4",children:[e("h4",{class:"text-lg font-semibold mb-2 text-blue-300",children:"Managram Message Preview:"}),e("label",{class:"inline-flex items-center mb-2 cursor-pointer",children:[e("input",{type:"checkbox",checked:T.value,onChange:()=>T.value=!T.value,class:"form-checkbox h-5 w-5 text-blue-600 rounded"}),e("span",{class:"ml-2 text-gray-300",children:"Use Custom Managram Message"})]}),T.value?e("textarea",{value:R.value,onInput:a=>R.value=a.target.value,placeholder:"Enter your custom message here...",rows:4,maxLength:100,class:"w-full p-2 bg-gray-800 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100"}):e("div",{class:"p-2 bg-gray-800 border border-gray-600 rounded-md text-gray-300 break-words whitespace-pre-wrap",children:Q}),e("p",{class:"mt-1 text-xs text-gray-400",children:"Example data, data will be unique to each user if you choose the automatic option. No dynamic options in custom managram mode."})]}),e("button",{type:"button",onClick:X,disabled:v.value||u.value.length===0||!P.value,class:`mt-6 w-full py-3 px-4 rounded-md font-bold text-lg transition-colors duration-200
            ${v.value?"bg-gray-700 text-gray-400 cursor-not-allowed":d.value?"bg-yellow-600 hover:bg-yellow-700 text-white":"bg-green-600 hover:bg-green-700 text-white"}`,children:v.value?"Executing Payouts...":d.value?"Confirm Payouts (Click again to proceed)":`Execute Payouts for ${M.value} Users`})]}),i.value&&e("div",{class:`mt-6 p-4 rounded-md ${g.value&&g.value.length>0?"bg-red-800 border border-red-600":"bg-green-800 border border-green-600"}`,children:[e("p",{class:"font-bold text-lg mb-2",children:i.value}),I.value!==null&&e("p",{children:["Total Mana Paid: M",I.value]}),h.value!==null&&e("p",{children:["Payout Errors: ",h.value]}),f.value&&f.value.length>0&&e("div",{class:"mt-4",children:[e("h4",{class:"font-semibold mb-1",children:"Successful Transactions:"}),e("ul",{class:"text-sm max-h-40 overflow-y-auto",children:f.value.map(a=>e("li",{class:"text-gray-200",children:["@",a.username,": M",u.value.find(l=>l.userId===a.userId)?.calculatedPayout," (Tx ID: ",a.transactionId,")"]},a.transactionId))})]}),g.value&&g.value.length>0&&e("div",{class:"mt-4",children:[e("h4",{class:"font-semibold text-red-300 mb-1",children:"Failed Payouts:"}),e("ul",{class:"text-sm max-h-40 overflow-y-auto",children:g.value.map((a,l)=>e("li",{class:"text-red-200",children:["@",a.username," (",a.userId,"): ",a.error]},l))})]}),k.value&&e("p",{class:"mt-4 text-orange-300 font-semibold",children:k.value}),c.value&&c.value.length>0&&e(N,{children:[e("p",{class:"mt-4 text-sm text-gray-400 text-center",children:"Log has been downloaded automatically, but feel free to click the button"}),e("button",{type:"button",onClick:$,class:"mt-2 w-full p-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-md transition-colors duration-200",children:"Download Detailed Execution Log (JSON)"})]})]})]})}export{V as default};
